<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Correction</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background: #f7f8fa;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 1100px;
            /* 增大宽度以容纳侧栏 */
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px #0001;
            padding: 32px 28px 24px 28px;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }
        .header {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 18px;
            color: #222;
        }
        .editor-area {
            position: relative;
            margin-bottom: 18px;
            flex: 1;
            min-width: 0;
        }
        .editor {
            min-height: 90px;
            width: 100%;
            border: 1.5px solid #c3c8d1;
            border-radius: 8px;
            padding: 14px 12px;
            font-size: 1.1rem;
            outline: none;
            transition: border 0.2s;
            background: #fafdff;
        }
        .editor:focus {
            border-color: #4f8cff;
            background: #fff;
        }
        .check-btn {
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 22px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .check-btn:disabled {
            background: #b3cfff;
            cursor: not-allowed;
        }
        .suggestion {
            position: relative;
            display: inline-block;
        }
        .underline {
            position: absolute;
            left: 0;
            right: 0;
            bottom: -2px;
            height: 2px;
            background: linear-gradient(to right, #f7b500 60%, transparent 0%);
            background-size: 6px 2px;
            background-repeat: repeat-x;
            border-radius: 1px;
            pointer-events: none;
        }
        .actions-bar {
            margin-top: 18px;
            color: #888;
            font-size: 0.98rem;
        }
        .suggestion-delete {
            background: #ffeaea;
            border-bottom: 2px dotted #e74c3c;
        }
        .suggestion-append {
            background: #eaffea;
            border-bottom: 2px dotted #27ae60;
        }
        /* 新增侧栏样式 */
        .sidebar {
            /* 侧栏不再悬浮，直接右侧排列 */
            position: static;
            margin-left: 36px;
            width: 320px;
            max-height: 70vh;
            background: #fafdff;
            border: 1.5px solid #c3c8d1;
            border-radius: 10px;
            box-shadow: 0 2px 12px #0001;
            padding: 16px 14px 12px 14px;
            overflow-y: auto;
            z-index: 1;
        }
        .sidebar-title {
            font-weight: bold;
            font-size: 1.08rem;
            margin-bottom: 10px;
            color: #4f8cff;
        }
        .sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sidebar-item {
            background: #fffbe6;
            border-left: 4px solid #f7b500;
            border-radius: 5px;
            padding: 8px 10px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.98rem;
            margin-bottom: 4px;
            position: relative;
        }
        .sidebar-item:hover {
            background: #fff3c1;
        }
        .apply-btn {
            display: none;
            position: absolute;
            right: 12px;
            top: 10px;
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 3px 12px;
            font-size: 0.97em;
            cursor: pointer;
            font-weight: 600;
            z-index: 2;
            transition: background 0.18s;
        }
        .sidebar-item:hover .apply-btn {
            display: inline-block;
        }
        .apply-btn:active {
            background: #2562c7;
        }
        .sidebar-item.active,
        .sidebar-item[data-active="true"] {
            background: #e6f0ff !important;
            border-left-color: #4f8cff !important;
            /* 可选：让 Apply 按钮常显 */
        }
        .sidebar-item.active .apply-btn,
        .sidebar-item[data-active="true"] .apply-btn {
            display: inline-block;
        }
    </style>
</head>
<body>
<div id="app" class="container" style="display:flex;flex-direction:row;align-items:flex-start;">
    <div style="flex:1;min-width:0;">
        <div class="header">Grammar Correction (Grammarly Style)</div>
        <div class="editor-area" style="position:relative;">
            <div
                class="editor"
                contenteditable="true"
                spellcheck="false"
                ref="editor"
                v-html="editorHtml"
                @input="onInput"
                @keydown.enter.prevent="onEnter"
                @click="onEditorClick"
            ></div>
        </div>
        <button class="check-btn" :disabled="loading || !inputText.trim()" @click="checkGrammar">
            {{ loading ? 'Checking...' : 'Check Grammar' }}
        </button>
        <div class="actions-bar" v-if="actions && actions.length">
            {{ actions.length }} suggestion{{ actions.length > 1 ? 's' : '' }} found.
        </div>
        <div class="actions-bar" v-else>
            <span style="color:#27ae60;font-weight:600;">Grammar is correct!</span>
        </div>
    </div>
    <!-- 侧栏紧挨主文本框右侧 -->
    <div class="sidebar" v-if="actions && actions.length">
        <div class="sidebar-title">Suggestions</div>
        <div class="sidebar-list">
            <div
                v-for="(act, idx) in actions"
                :key="idx"
                class="sidebar-item"
                :data-active="hoveredSidebarIdx === idx"
                @mouseenter="hoveredSidebarIdx = idx"
                @mouseleave="hoveredSidebarIdx = null"
            >
                <div>
                    <b>Type:</b>
                    <span v-if="act.action === '$DELETE'">Delete</span>
                    <span v-else-if="act.action.startsWith('$APPEND_')">Append</span>
                    <span v-else-if="act.action.startsWith('$TRANSFORM_')">Transform</span>
                    <span v-else-if="act.action.startsWith('$REPLACE_')">Replace</span>
                    <span v-else>{{ act.action }}</span>
                </div>
                <div><b>Original:</b> <i>{{ act.original }}</i></div>
                <div><b>Suggestion:</b> <i>{{ act.real_replacement }}</i></div>    
                <div><b>Confidence:</b> {{ Math.round(act.confidence * 100) }}%</div>
                <div v-if="act.action"><b>Action:</b> {{ act.action }}</div>
                <div style="color:#888;font-size:0.95em;"><i>Click Apply to fix</i></div>
                <button
                    class="apply-btn"
                    v-if="hoveredSidebarIdx === idx"
                    @click="applySidebarSuggestion(idx)"
                >Apply</button>
            </div>
        </div>
    </div>
</div>
<script>
const { createApp, nextTick } = Vue

createApp({
    data() {
        return {
            inputText: '',
            displayTokens: [],
            actions: [],
            loading: false,
            editorHtml: '',
            hoveredSidebarIdx: null
        }
    },
    mounted() {
        this.inputText = 'the list of item are on the table since yesterday.'
        this.renderTokens(this.inputText)
        // 页面加载后如果输入框有文字，自动检测一次语法
        if (this.inputText && this.inputText.trim()) {
            this.checkGrammar()
        }
    },
    methods: {
        onInput(e) {
            this.inputText = this.getEditorText()
            this.renderTokens(this.inputText)
        },
        getEditorText() {
            // Get plain text from contenteditable
            return this.$refs.editor.innerText.replace(/\s+/g, ' ').trim()
        },
        renderTokens(text) {
            // 先按空格分词
            const tokens = text.split(' ').filter(t => t.length)
            this.displayTokens = tokens.map(t => ({ text: t }))
            if (this.actions && this.actions.length) {
                this.actions.forEach((act, i) => {
                    if (act.action === '$DELETE') {
                        for (let idx = act.start; idx < act.end; ++idx) {
                            if (this.displayTokens[idx]) {
                                this.displayTokens[idx] = {
                                    ...this.displayTokens[idx],
                                    suggestion: act,
                                    suggestionType: 'delete',
                                    actionIdx: i // 记录建议在actions中的索引
                                }
                            }
                        }
                    } else if (act.action.startsWith('$APPEND_')) {
                        this.displayTokens.splice(act.end, 0, {
                            text: act.real_replacement,
                            suggestion: act,
                            suggestionType: 'append',
                            isVirtual: true,
                            actionIdx: i
                        })
                    } else {
                        for (let idx = act.start; idx < act.end; ++idx) {
                            if (this.displayTokens[idx]) {
                                this.displayTokens[idx] = {
                                    ...this.displayTokens[idx],
                                    suggestion: act,
                                    suggestionType: 'replace',
                                    actionIdx: i
                                }
                            }
                        }
                    }
                })
            }
            this.updateEditorHtml()
        },
        updateEditorHtml() {
            // 为每个 token 添加 data-idx 属性，便于事件代理
            let html = ''
            this.displayTokens.forEach((token, idx) => {
                if (token.suggestion) {
                    // 不改变单词样式，仅在下方加下划线
                    html += `<span class="suggestion" data-idx="${idx}" style="position:relative;display:inline-block;">${token.text}<span class="underline" style="width:100%;"></span></span>`
                } else {
                    html += `<span data-idx="${idx}">${token.text}</span>`
                }
                if (idx !== this.displayTokens.length - 1) html += ' '
            })
            this.editorHtml = html
        },
        async checkGrammar() {
            this.loading = true
            try {
                const resp = await fetch('/api/actions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sentence: this.inputText })
                })
                const result = await resp.json()
                this.actions = result.actions || []
                // 直接用原始文本和 actions 渲染
                this.renderTokens(result.original)
            } finally {
                this.loading = false
            }
        },
        onEditorClick(e) {
            // 若点击了错误单词，则高亮对应侧栏item
            const target = e.target
            if (target.classList && target.classList.contains('suggestion')) {
                const idx = Number(target.getAttribute('data-idx'))
                const token = this.displayTokens[idx]
                if (token && typeof token.actionIdx === 'number') {
                    this.hoveredSidebarIdx = token.actionIdx

                }
            }
        },
        applySuggestion(idx) {
            // 保留但不再被调用
        },
        applySidebarSuggestion(actionIdx) {
            // 侧栏点击“Apply”按钮才应用建议
            const act = this.actions[actionIdx]
            if (!act) return
            let tokens = this.displayTokens.filter(t => !t.isVirtual).map(t => t.text)
            if (act.action === '$DELETE') {
                tokens.splice(act.start, act.end - act.start)
            } else if (act.action.startsWith('$APPEND_')) {
                tokens.splice(act.end, 0, act.real_replacement)
            } else if (act.action.startsWith('$TRANSFORM_') || act.action.startsWith('$REPLACE_')) {
                tokens.splice(act.start, act.end - act.start, act.real_replacement)
            } else {
                tokens.splice(act.start, act.end - act.start, act.real_replacement)
            }
            this.inputText = tokens.join(' ')
            this.actions = []
            this.renderTokens(this.inputText)
            this.checkGrammar()
        },
        onEnter() {
            this.checkGrammar()
        }
    },
}).mount('#app')
</script>
</body>
</html>
