<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Grammar Correction</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            background: #f7f8fa;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .container {
            max-width: 700px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px #0001;
            padding: 32px 28px 24px 28px;
        }
        .header {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 18px;
            color: #222;
        }
        .editor-area {
            position: relative;
            margin-bottom: 18px;
        }
        .editor {
            min-height: 90px;
            width: 100%;
            border: 1.5px solid #c3c8d1;
            border-radius: 8px;
            padding: 14px 12px;
            font-size: 1.1rem;
            outline: none;
            transition: border 0.2s;
            background: #fafdff;
        }
        .editor:focus {
            border-color: #4f8cff;
            background: #fff;
        }
        .check-btn {
            background: #4f8cff;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 22px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 600;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .check-btn:disabled {
            background: #b3cfff;
            cursor: not-allowed;
        }
        .suggestion {
            background: #fffbe6;
            border-bottom: 2px dotted #f7b500;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.15s;
            position: relative;
        }
        .suggestion:hover {
            background: #fff3c1;
        }
        .tooltip {
            position: absolute;
            z-index: 10;
            left: 0;
            top: 120%;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-shadow: 0 2px 8px #0002;
            padding: 10px 14px;
            min-width: 180px;
            font-size: 0.98rem;
            color: #222;
            white-space: pre-line;
        }
        .actions-bar {
            margin-top: 18px;
            color: #888;
            font-size: 0.98rem;
        }
        .suggestion-delete {
            background: #ffeaea;
            border-bottom: 2px dotted #e74c3c;
        }
        .suggestion-append {
            background: #eaffea;
            border-bottom: 2px dotted #27ae60;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <div class="header">Grammar Correction (Grammarly Style)</div>
    <div class="editor-area" style="position:relative;">
        <div
            class="editor"
            contenteditable="true"
            spellcheck="false"
            ref="editor"
            v-html="editorHtml"
            @input="onInput"
            @keydown.enter.prevent="onEnter"
            @mousemove="onEditorMouseMove"
            @mouseleave="hideTooltip"
            @click="onEditorClick"
        ></div>
        <!-- tooltip 显示，放在 editor-area 内部，便于定位 -->
        <div
            v-if="tooltipIdx !== null"
            :style="tooltipStyle"
            class="tooltip"
            v-html="tooltipContent"
        ></div>
    </div>
    <button class="check-btn" :disabled="loading || !inputText.trim()" @click="checkGrammar">
        {{ loading ? 'Checking...' : 'Check Grammar' }}
    </button>
    <div class="actions-bar" v-if="actions && actions.length">
        {{ actions.length }} suggestion{{ actions.length > 1 ? 's' : '' }} found.
    </div>
</div>
<script>
const { createApp, nextTick } = Vue

createApp({
    data() {
        return {
            inputText: '',
            displayTokens: [],
            actions: [],
            loading: false,
            tooltipIdx: null,
            tooltipStyle: {},
            editorHtml: ''
        }
    },
    mounted() {
        this.inputText = 'the list of item are on the table since yesterday.'
        this.renderTokens(this.inputText)
    },
    methods: {
        onInput(e) {
            this.inputText = this.getEditorText()
            this.renderTokens(this.inputText)
        },
        getEditorText() {
            // Get plain text from contenteditable
            return this.$refs.editor.innerText.replace(/\s+/g, ' ').trim()
        },
        renderTokens(text) {
            // 先按空格分词
            const tokens = text.split(' ').filter(t => t.length)
            // 为每个 token 构建对象
            this.displayTokens = tokens.map(t => ({ text: t }))
            // 如果有 actions，则标记涉及的 token
            if (this.actions && this.actions.length) {
                // 标记每个 token 是否涉及建议
                this.actions.forEach((act, i) => {
                    // 删除操作: 高亮被删除的 token
                    if (act.action === '$DELETE') {
                        for (let idx = act.start; idx < act.end; ++idx) {
                            if (this.displayTokens[idx]) {
                                this.displayTokens[idx] = {
                                    ...this.displayTokens[idx],
                                    suggestion: act,
                                    suggestionType: 'delete'
                                }
                            }
                        }
                    // 追加操作: 在指定位置后插入一个虚拟 token 用于显示追加内容
                    } else if (act.action.startsWith('$APPEND_')) {
                        // 追加内容显示在 end 位置（即 start 后面）
                        this.displayTokens.splice(act.end, 0, {
                            text: act.real_replacement,
                            suggestion: act,
                            suggestionType: 'append',
                            isVirtual: true // 标记为虚拟 token
                        })
                    // 其它操作（替换、变形等）: 高亮被替换的 token
                    } else {
                        for (let idx = act.start; idx < act.end; ++idx) {
                            if (this.displayTokens[idx]) {
                                this.displayTokens[idx] = {
                                    ...this.displayTokens[idx],
                                    suggestion: act,
                                    suggestionType: 'replace'
                                }
                            }
                        }
                    }
                })
            }
            this.updateEditorHtml()
        },
        updateEditorHtml() {
            // 为每个 token 添加 data-idx 属性，便于事件代理
            let html = ''
            this.displayTokens.forEach((token, idx) => {
                if (token.suggestion) {
                    // 不同类型高亮不同样式
                    let cls = 'suggestion'
                    if (token.suggestionType === 'delete') cls += ' suggestion-delete'
                    if (token.suggestionType === 'append') cls += ' suggestion-append'
                    html += `<span class="${cls}" data-idx="${idx}">${token.text}</span>`
                } else {
                    html += `<span data-idx="${idx}">${token.text}</span>`
                }
                if (idx !== this.displayTokens.length - 1) html += ' '
            })
            this.editorHtml = html
        },
        async checkGrammar() {
            this.loading = true
            this.tooltipIdx = null
            try {
                const resp = await fetch('/api/actions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sentence: this.inputText })
                })
                const result = await resp.json()
                this.actions = result.actions || []
                // 直接用原始文本和 actions 渲染
                this.renderTokens(result.original)
            } finally {
                this.loading = false
            }
        },
        onEditorMouseMove(e) {
            const target = e.target
            if (target.classList && target.classList.contains('suggestion')) {
                const idx = Number(target.getAttribute('data-idx'))
                if (this.tooltipIdx !== idx) {
                    this.tooltipIdx = idx
                    // 计算 tooltip 相对于 editor-area 的偏移
                    const editorArea = this.$el.querySelector('.editor-area')
                    const areaRect = editorArea.getBoundingClientRect()
                    const rect = target.getBoundingClientRect()
                    this.tooltipStyle = {
                        position: 'absolute',
                        left: (rect.left - areaRect.left) + 'px',
                        top: (rect.bottom - areaRect.top + 6) + 'px'
                    }
                }
            } else {
                this.hideTooltip()
            }
        },
        hideTooltip() {
            this.tooltipIdx = null
        },
        onEditorClick(e) {
            const target = e.target
            if (target.classList && target.classList.contains('suggestion')) {
                const idx = Number(target.getAttribute('data-idx'))
                this.applySuggestion(idx)
            }
        },
        applySuggestion(idx) {
            // 找到当前 token 的 suggestion
            const token = this.displayTokens[idx]
            const sug = token.suggestion
            if (!sug) return
            let tokens = this.displayTokens.filter(t => !t.isVirtual).map(t => t.text)
            // 根据 action 类型处理
            if (sug.action === '$DELETE') {
                // 删除 start~end 的 token
                tokens.splice(sug.start, sug.end - sug.start)
            } else if (sug.action.startsWith('$APPEND_')) {
                // 在 end 位置插入 real_replacement
                tokens.splice(sug.end, 0, sug.real_replacement)
            } else if (sug.action.startsWith('$TRANSFORM_') || sug.action.startsWith('$REPLACE_')) {
                // 替换 start~end 的 token
                tokens.splice(sug.start, sug.end - sug.start, sug.real_replacement)
            } else {
                // 其它操作，直接替换
                tokens.splice(sug.start, sug.end - sug.start, sug.real_replacement)
            }
            this.inputText = tokens.join(' ')
            this.actions = []
            this.renderTokens(this.inputText)
        },
        onEnter() {
            this.checkGrammar()
        }
    },
    computed: {
        tooltipContent() {
            if (this.tooltipIdx == null) return ''
            const token = this.displayTokens[this.tooltipIdx]
            if (!token || !token.suggestion) return ''
            // 展示 action 类型
            let type = ''
            if (token.suggestion.action === '$DELETE') type = 'Delete'
            else if (token.suggestion.action.startsWith('$APPEND_')) type = 'Append'
            else if (token.suggestion.action.startsWith('$TRANSFORM_')) type = 'Transform'
            else if (token.suggestion.action.startsWith('$REPLACE_')) type = 'Replace'
            else type = token.suggestion.action
            return `<b>Type:</b> ${type}<br>
<b>Suggestion:</b> ${token.suggestion.real_replacement}<br>
<b>Confidence:</b> ${Math.round(token.suggestion.confidence * 100)}%<br>
${token.suggestion.action ? `<b>Action:</b> ${token.suggestion.action}<br>` : ''}
<i>Click to apply</i>`
        }
    }
}).mount('#app')
</script>
</body>
</html>
